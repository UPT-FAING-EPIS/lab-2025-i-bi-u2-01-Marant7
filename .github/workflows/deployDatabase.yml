name: Deploy Dimensional Models with Liquibase
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'liquibase/**'
      - '.github/workflows/deploy-liquibase.yml'

env:
  DB_SERVER: "${{ secrets.DB_SERVER }}"  # Ej: 'tu-server.database.windows.net'
  DB_USER: "${{ secrets.SQL_ADMIN_USER }}"
  DB_PASSWORD: "${{ secrets.SQL_ADMIN_PASSWORD }}"

jobs:
  deploy-schemas:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        model_config:
          - { model: 'modelo01', db_name: 'dw_envios', sql_file: 'modelo01_envios.sql' }
          - { model: 'modelo02', db_name: 'dw_reservas_viaje', sql_file: 'modelo02_reservas.sql' }
          - { model: 'modelo03', db_name: 'dw_gestion_proyectos', sql_file: 'modelo03_proyectos.sql' }
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Liquibase and SQL Server driver
        run: |
          # Descargar y extraer Liquibase
          curl -L https://github.com/liquibase/liquibase/releases/download/v4.23.1/liquibase-4.23.1.tar.gz -o liquibase.tar.gz
          mkdir liquibase
          tar -xzf liquibase.tar.gz -C liquibase
          echo "$(pwd)/liquibase" >> $GITHUB_PATH
          
          # Descargar driver JDBC para SQL Server
          wget https://repo1.maven.org/maven2/com/microsoft/sqlserver/mssql-jdbc/12.4.2.jre11/mssql-jdbc-12.4.2.jre11.jar -O sqljdbc.jar
          echo "LIQUIBASE_CLASSPATH=$(pwd)/sqljdbc.jar" >> $GITHUB_ENV

      - name: Run Liquibase Update
        run: |
          liquibase \
            --url="jdbc:sqlserver://${{ env.DB_SERVER }}:1433;database=${{ matrix.model_config.db_name }};encrypt=true;trustServerCertificate=true" \
            --username="${{ env.DB_USER }}" \
            --password="${{ env.DB_PASSWORD }}" \
            --driver="com.microsoft.sqlserver.jdbc.SQLServerDriver" \
            --classpath="${{ env.LIQUIBASE_CLASSPATH }}" \
            --changeLogFile="liquibase/changelog/${{ matrix.model_config.model }}/changelog-master.xml" \
            --logLevel=info \
            update
